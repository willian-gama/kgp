version: 2.1

orbs:
  android: circleci/android@2.5.0

references:
  workspace: &workspace
               ~/src

  android_config: &android_config
    working_directory: *workspace
    environment:
      TERM: dumb
      _JAVA_OPTIONS: "-Xms3g -Xmx6g -XX:+UseParallelGC -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"
      GRADLE_OPTS: '-Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dorg.gradle.jvmargs="-Xms3g -Xmx6g -XX:+UseParallelGC -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"'

  generate_gradle_cache_key: &generate_gradle_cache_key
    run:
      name: Generate gradle cache key
      command: scripts/generate_gradle_checksum.sh gradle_checksum.txt

  restore_gradle_cache: &restore_gradle_cache
    restore_cache:
      name: Restore gradle cache
      key: gradle-{{ checksum "gradle_checksum.txt" }}

jobs:
  auto_bump:
    <<: *android_config
    executor:
      name: android/android-machine
      resource-class: large
      tag: default
    steps:
      - checkout
      - run:
          name: Include local.properties
          command: ./auto_bump.sh


  run_tests:
    <<: *android_config
    executor:
      name: android/android-machine
      resource-class: large
      tag: default
    steps:
      - checkout
      - *generate_gradle_cache_key
      - *restore_gradle_cache
      - run:
          name: Include local.properties
          command: scripts/include_local_properties.sh
      - run:
          name: run tests
          command: ./gradlew test

workflows:
  build_and_test:
    jobs:
      - auto_bump
      - run_tests:
          requires:
            - auto_bump